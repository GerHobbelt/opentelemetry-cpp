# Copyright The OpenTelemetry Authors
# SPDX-License-Identifier: Apache-2.0

# This auto-enables --config=windows if targeting Windows (and same for linux, osx, etc.)
common --enable_platform_specific_config

# Needed for aspect-dev's write_source_file to actually write the file back on Windows (where runfiles are disabled by default)
build --enable_runfiles
test --enable_runfiles

build --build_tag_filters=-jaeger,-opentracing,-opentracing_shim
test --test_tag_filters=-jaeger,-opentracing,-opentracing_shim

build --experimental_convenience_symlinks=clean
build --experimental_cc_implementation_deps

build:windows    --copt="/Brepro"    --copt="/guard:cf" --copt="/Z7" --copt="/JMC-" --cxxopt="/std:c++17" --copt="/sdl" --copt="-D_CRT_NONSTDC_NO_DEPRECATE"
build:windows --linkopt="/Brepro" --linkopt="/guard:cf" --linkopt="/DEBUG:FULL" --linkopt="/CETCOMPAT" --linkopt="/FUNCTIONPADMIN" --linkopt="/SWAPRUN:NET,CD" --linkopt="/PROFILE" --linkopt="/DEBUGTYPE:CV,PDATA,FIXUP"
# Requires Visual Studio 2019 Build Tools installed in default location with the latest compiler (14.29.30133) for x64
build:windows --action_env=BAZEL_VC_FULL_VERSION=14.29.30133

# Disable some warnings that were made into errors by /sdl
# com_github_grpc_grpc\src/core/lib/gprpp/time.h(254): error C4146: unary minus operator applied to unsigned type, result still unsigned
# upb\upb\def.c(617) : error C4700: uninitialized local variable 'ret' used
# upb\upb\msg.c(366) : error C4703: potentially uninitialized local pointer variable 'compar' used
# api/test/trace/propagation/jaeger_propagation_test.cc(34): error C4996: 'opentelemetry::v1::trace::propagation::JaegerPropagator': was declared deprecated 
build:windows --copt="/wd4146"  --copt="/wd4700" --copt="/wd4703"

# extra silence of C++17 msvc warnings (these happen only with abseil so far)
build:windows --copt="-D_SILENCE_ALL_CXX17_DEPRECATION_WARNINGS"

# external/com_github_grpc_grpc/src/core/lib/iomgr/tcp_server_windows.cc(502): error C4996: 'WSASocketA': Use WSASocketW() instead or define _WINSOCK_DEPRECATED_NO_WARNINGS to disable deprecated API warnings
# Use this define, instead of disabling 4996 - /wd4996
build:windows --copt="-D_WINSOCK_DEPRECATED_NO_WARNINGS"

# --copt="/wd4996"

# --config=asan : Address Sanitizer.
common:asan --copt -DADDRESS_SANITIZER
common:asan --copt -fsanitize=address,bool,float-cast-overflow,integer-divide-by-zero,null,return,returns-nonnull-attribute,shift-exponent,signed-integer-overflow,unreachable,vla-bound
common:asan --copt -fsanitize-address-use-after-scope
common:asan --copt -fno-sanitize-recover=all
common:asan --linkopt -fsanitize=address,bool,float-cast-overflow,integer-divide-by-zero,null,return,returns-nonnull-attribute,shift-exponent,signed-integer-overflow,unreachable,vla-bound
common:asan --linkopt -fsanitize-address-use-after-scope
common:asan --linkopt -fno-sanitize-recover=all
common:asan --cc_output_directory_tag=asan

# --config=tsan : Thread Sanitizer.
common:tsan --copt -fsanitize=thread
common:tsan --copt -DTHREAD_SANITIZER
common:tsan --linkopt -fsanitize=thread
common:tsan --cc_output_directory_tag=tsan
# This is needed to address false positive problem with abseil.The same setting as gRPC
# https://github.com/google/sanitizers/issues/953
common:tsan --test_env=TSAN_OPTIONS=report_atomic_races=0

## This is what my ../top.bazelrc contains (not in the repo as local to my machine)
# build --disk_cache=f:/b/d
# common --repository_cache=f:/b/r
# startup --output_user_root=f:/b/u
try-import %workspace%/../top.bazelrc
